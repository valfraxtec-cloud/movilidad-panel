<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movilidad ‚Äî Panel</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#0b0f15; --panel:#0f1522; --card:#11192b; --muted:#9fb0c7; --text:#e6eef9;
      --accent:#41a4ff; --accent2:#22c55e; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%, #12203a 0%, #0b0f15 45%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif}

    /* Header */
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #1b2a44;background:rgba(10,15,25,.7);backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
    header .brand{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:10px;background:conic-gradient(from 70deg,#41a4ff,#22c55e,#41a4ff);display:grid;place-items:center;box-shadow:0 0 0 1px #1b2a44}
    .brand h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.3px}
    header .user{font-size:13px;color:var(--muted)}
    .badge{font-size:12px;border:1px solid #274166;background:#0d1628;color:#b7c5da;border-radius:999px;padding:6px 10px}

    /* Botonera superior en dash/map */
    .top-actions{display:flex;gap:10px}
    .btn{border-radius:12px;border:1px solid #20334f;background:#0c1322;color:var(--text);padding:10px 14px;font-size:14px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#1b4d9f,#143a78);border-color:#1b4d9f}
    .btn.ghost{background:transparent;border-color:#2a3a57}
    .btn.small{padding:8px 12px;font-size:13px}

    /* Center (login) */
    .center{min-height:calc(100% - 56px);display:grid;place-items:center;padding:24px}
    .card{background:linear-gradient(180deg,#0f1726,#0b111d);border:1px solid #1b2a44;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);width:min(480px,92vw)}
    .card h2{margin:0 0 10px 0;font-size:18px}
    .subtitle{color:var(--muted);font-size:13px;margin-bottom:14px}
    .col{display:flex;flex-direction:column;gap:10px}
    label{font-size:12px;color:#9fb0c7}
    input{width:100%;border-radius:12px;border:1px solid #20334f;background:#0c1322;color:var(--text);padding:12px 12px;font-size:14px;outline:none}
    input::placeholder{color:#7f91ac}
    .hint{font-size:12px;color:#8ea2bf}
    .error{color:var(--danger);font-size:12px;min-height:16px}

    /* Contenedor general */
    .container{padding:18px}

    /* Vista rutas */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
    .tile{background:linear-gradient(180deg,#0f1726,#0a0f1b);border:1px solid #1b2a44;border-radius:16px;padding:16px;cursor:pointer;position:relative;overflow:hidden}
    .tile:hover{box-shadow:0 8px 24px rgba(0,0,0,.35);transform:translateY(-1px)}
    .tile h3{margin:6px 0 0 0;font-size:16px}
    .chip{display:inline-flex;gap:8px;align-items:center;border:1px solid #233a5d;border-radius:999px;padding:6px 10px;font-size:12px;color:#b8c7de;background:#0e1525}
    .tile .icon{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#41a4ff33,#22c55e33);display:grid;place-items:center;border:1px solid #2a3a57}

    /* Panel mapa+c√°maras */
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:16px;}
    .panel{background:linear-gradient(180deg,#0f1726,#0a0f1b);border:1px solid #1b2a44;border-radius:16px;}
    .panel h3{margin:0;padding:12px 14px;border-bottom:1px solid #1b2a44;font-size:16px;display:flex;align-items:center;gap:8px}
    #map{height: calc(80vh - 56px); border-radius:0 0 16px 16px}
    .cams{display:flex;flex-direction:column;gap:16px;height:calc(80vh - 56px);padding:16px}
    .camBox{flex:1;background:#000;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#9aa7bd;border:1px solid #1b2a44}

    @media (max-width: 980px){
      .split{grid-template-columns: 1fr}
      #map,.cams{height:60vh}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand"><div class="logo">üöç</div><h1>Movilidad ‚Äî Panel</h1></div>
    <div class="user" id="userLabel">Invitado</div>
  </header>

  <!-- LOGIN -->
  <main id="view-login" class="center">
    <section class="card">
      <h2>Iniciar sesi√≥n</h2>
      <p class="subtitle">Acceso para encargados de movilidad</p>
      <div class="col">
        <div class="col">
          <label for="user">Usuario</label>
          <input id="user" placeholder="Usuario" autocomplete="username" />
        </div>
        <div class="col">
          <label for="pass">Contrase√±a</label>
          <input id="pass" type="password" placeholder="Contrase√±a" autocomplete="current-password" />
        </div>
        <div class="error" id="loginError"></div>
        <button class="btn primary" id="btnLogin">Entrar</button>
        <p class="hint">Sugerido: <b>12345</b> / <b>12345</b> (puedes cambiarlo en el c√≥digo).</p>
      </div>
    </section>
  </main>

  <!-- RUTAS -->
  <main id="view-routes" style="display:none">
    <div class="container">
      <div class="toolbar" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <span class="badge">üõ∞ Fuente: Traccar Local</span>
        <div class="top-actions">
          <button class="btn ghost small" id="btnLogout1">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div class="grid">
        <div class="tile" id="tileRutaTepic">
          <div class="row" style="display:flex;gap:12px;align-items:center">
            <div class="icon">üó∫</div>
            <div>
              <div class="chip">Ubicaci√≥n</div>
              <h3>Ruta Tepic</h3>
              <div style="color:#8ea2bf;font-size:12px;margin-top:6px">Entra para ver mapa + c√°maras</div>
            </div>
          </div>
        </div>
        <!-- (Aqu√≠ luego puedes a√±adir m√°s rutas) -->
      </div>
    </div>
  </main>

  <!-- PANEL MAPA+C√ÅMARAS -->
  <main id="view-dash" style="display:none">
    <div class="container">
      <div class="toolbar" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <span class="badge">üõ∞ Fuente: Traccar Local</span>
        <div class="top-actions">
          <button class="btn ghost small" id="btnBack">‚Üê Volver</button>
          <button class="btn ghost small" id="btnLogout2">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div class="split">
        <!-- Izquierda: MAPA -->
        <section class="panel">
          <h3>üìç Posici√≥n ‚Äî <span id="routeName">Ruta Tepic</span>
            <small id="errText" style="color:#ef4444;margin-left:10px;"></small>
          </h3>
          <div id="map"></div>
        </section>

        <!-- Derecha: C√ÅMARAS -->
        <section class="panel">
          <h3>üé• C√°maras</h3>
          <div class="cams">
            <div class="camBox">Cam 1 (pendiente)</div>
            <div class="camBox">Cam 2 (pendiente)</div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
    /* ========= CONFIG ========= */
    // Credenciales de TU login interno (pantalla de inicio, solo UI local)
    const CREDS = { user: '12345', pass: '12345' };

    // ======= Traccar (tu servidor expuesto por ngrok) =======
    const TRACCAR_EMAIL    = "valfrax.tec@gmail.com";
    const TRACCAR_PASSWORD = "123456";
    const DEVICE_ID        = 32324706;

    // Dominio p√∫blico que te da ngrok (no lleve barra final)
    const BASE  = "https://fbbf183c1610.ngrok-free.app";

    // Construye URL de API (directo, sin proxy)
    function api(p){ return BASE + p; }
    function authHeader(){ return 'Basic ' + btoa(`${TRACCAR_EMAIL}:${TRACCAR_PASSWORD}`); }

    /* ====== Estado simple/vistas ====== */
    const vLogin  = document.getElementById('view-login');
    const vRoutes = document.getElementById('view-routes');
    const vDash   = document.getElementById('view-dash');
    const userLabel = document.getElementById('userLabel');
    const errText   = document.getElementById('errText');
    const routeName = document.getElementById('routeName');

    function show(view){
      vLogin.style.display  = view==='login'?  '' : 'none';
      vRoutes.style.display = view==='routes'? '' : 'none';
      vDash.style.display   = view==='dash'?   '' : 'none';
    }
    function isAuthed(){ return sessionStorage.getItem('authed')==='1'; }
    function setAuthed(v){ sessionStorage.setItem('authed', v?'1':'0'); }

    /* ====== Login local ====== */
    const inputUser = document.getElementById('user');
    const inputPass = document.getElementById('pass');
    const btnLogin  = document.getElementById('btnLogin');
    const loginError = document.getElementById('loginError');

    function doLogin(){
      const u = inputUser.value.trim();
      const p = inputPass.value.trim();
      if(u===CREDS.user && p===CREDS.pass){
        setAuthed(true); userLabel.textContent = u; show('routes');
      }else{
        loginError.textContent = 'Usuario o contrase√±a incorrectos.';
        setTimeout(()=> loginError.textContent = '', 2500);
      }
    }
    btnLogin.addEventListener('click', doLogin);
    inputPass.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

    if(isAuthed()){ userLabel.textContent = CREDS.user; show('routes'); }

    document.getElementById('btnLogout1').addEventListener('click', ()=>{ setAuthed(false); userLabel.textContent='Invitado'; show('login'); });
    document.getElementById('btnLogout2').addEventListener('click', ()=>{ setAuthed(false); userLabel.textContent='Invitado'; show('login'); });

    /* ====== Rutas ====== */
    document.getElementById('tileRutaTepic').addEventListener('click', ()=>{
      routeName.textContent = 'Ruta Tepic';
      show('dash');
      setTimeout(startTracking, 60);
    });

    document.getElementById('btnBack').addEventListener('click', ()=>{
      stopTracking();
      show('routes');
    });

    /* ====== Mapa ====== */
    let map, marker, pollId;
    function initMap(){
      if(map) return;
      map = L.map('map', { zoomControl:true, attributionControl:true })
              .setView([23.6345,-102.5528], 5); // vista M√©xico
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(map);
    }

    async function fetchPositionViaBasic() {
      const url = api(`/api/positions?deviceId=${DEVICE_ID}`);
      const res = await fetch(url, { headers: { 'Authorization': authHeader() } });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const arr = await res.json();
      return arr?.[0] || null;
    }

    async function refreshOnce(){
      try{
        errText.textContent = '';
        const pos = await fetchPositionViaBasic();
        if(!pos) return;
        const { latitude, longitude } = pos;
        if(!marker){
          marker = L.marker([latitude, longitude]).addTo(map);
          map.setView([latitude, longitude], 16);
        } else {
          marker.setLatLng([latitude, longitude]);
        }
      }catch(e){
        console.error(e);
        errText.textContent = 'Error: no se pudo obtener la posici√≥n (Auth/Endpoint).';
      }
    }

    function stopTracking(){
      if (pollId) clearInterval(pollId);
      pollId = null;
    }

    async function startTracking(){
      initMap();
      await refreshOnce();
      stopTracking();
      pollId = setInterval(refreshOnce, 10000); // refresco cada 10s
    }
  </script>
</body>
</html>
