<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movilidad ‚Äî Panel</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#0b0f15; --panel:#0f1522; --card:#11192b; --muted:#789; --text:#e6eef9;
      --accent:#14a4ff; --accent2:#22c55e; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background:#0a0f1a;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 18px; border-bottom:1px solid #1b2a44;
      background:rgba(10,15,25,.7); backdrop-filter:blur(6px); position:sticky; top:0; z-index:10;
    }
    .logo{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.2px;}
    .badge{padding:4px 8px; font-size:12px; border-radius:999px; background:#1e293b; color:#88a; margin-left:8px}
    .btn{
      border-radius:12px; border:1px solid #22403f; color:var(--text);
      padding:10px 14px; font-size:14px; cursor:pointer; background:#0b1324;
    }
    .btn:hover{background:#0f182c}
    .btn-primary{border-color:#1478ff; background:#0d2a5a}
    .btn-danger{border-color:#702020; background:#2a0d0d}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:14px;}
    @media (max-width: 1100px){ .row{grid-template-columns:1fr} }
    .card{background:var(--panel); border:1px solid #19253a; border-radius:16px; overflow:hidden}
    .card h3{margin:0; padding:12px 14px; border-bottom:1px solid #172238; font-size:14px; color:#9fb3c8}
    #map{height:520px}
    .cams{display:grid; gap:14px; padding:14px}
    .cam{
      height:240px; background:#0a1324; border:1px dashed #1b2a44;
      display:grid; place-items:center; color:#7c8aa3; border-radius:12px;
    }
    .alert{
      background:#2d0f16; color:#ffb3b3; border-top:1px solid #4d1c27; border-bottom:1px solid #4d1c27;
      padding:10px 12px; font-size:13px;
    }
    .toolbar{display:flex; align-items:center; gap:8px}
    .logs{padding:8px 12px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; height:120px; overflow:auto;}
    .pill{display:inline-grid; place-items:center; width:8px; height:8px; border-radius:999px; margin-right:8px}
    .ok{background:#22c55e}.err{background:#ef4444}.muted{background:#64748b}
    .footer{padding:10px 14px; color:#7b8aa6; font-size:12px}
    .hidden{display:none}
  </style>
</head>
<body>

<header>
  <div class="logo">
    <span>üöç Movilidad ‚Äî Panel</span>
    <span id="statusBadge" class="badge">Desconectado</span>
  </div>
  <div class="toolbar">
    <button id="backBtn" class="btn">‚Üê Volver</button>
    <button id="connectBtn" class="btn btn-primary">Conectar a Traccar</button>
    <button id="logoutBtn" class="btn btn-danger hidden">Cerrar sesi√≥n</button>
  </div>
</header>

<div id="topAlert" class="alert hidden"></div>

<div class="row">
  <section class="card">
    <h3>üìç Posici√≥n ‚Äî Ruta Tepic</h3>
    <div id="map"></div>
    <div class="footer">
      Lat/Lon: <span id="latlon">‚Äî</span> ‚Äî
      Velocidad: <span id="speed">‚Äî</span> nudos ‚Äî
      Actualizado: <span id="updated">‚Äî</span>
    </div>
  </section>

  <aside class="card">
    <h3>üìπ C√°maras</h3>
    <div class="cams">
      <div class="cam">Cam 1 (pendiente)</div>
      <div class="cam">Cam 2 (pendiente)</div>
    </div>
    <h3>üß™ Logs</h3>
    <pre id="logs" class="logs">Sin eventos‚Ä¶</pre>
  </aside>
</div>

<script>
/* ==============================
   CONFIGURACI√ìN (puedes editar)
   ============================== */
const CFG = {
  ENDPOINT: 'https://fbbf183c1610.ngrok-free.app', // tu ngrok estable
  EMAIL: 'valfrax.tec@gmail.com',
  PASSWORD: '123456',
  DEVICE_ID: 32324706,
  POLL_MS: 15000  // cada 15 s
};

/* ==========
   UTILIDADES
   ========== */
const $ = (sel) => document.querySelector(sel);
const logBox = $('#logs');
function log(line, type='muted'){
  const time = new Date().toLocaleTimeString();
  logBox.textContent += `\n[${time}] ${line}`;
  logBox.scrollTop = logBox.scrollHeight;
}
function setAlert(msg, isError=true){
  const box = $('#topAlert');
  if(!msg){ box.classList.add('hidden'); box.textContent=''; return; }
  box.textContent = msg;
  box.classList.toggle('hidden', false);
  box.style.background = isError ? '#2d0f16' : '#0f2d1a';
  box.style.color = isError ? '#ffb3b3' : '#b7ffcf';
}
function setStatus(connected){
  $('#statusBadge').textContent = connected ? 'Conectado' : 'Desconectado';
  $('#statusBadge').style.background = connected ? '#10351f' : '#1e293b';
  $('#statusBadge').style.color = connected ? '#b7ffd2' : '#88a';
  $('#connectBtn').classList.toggle('hidden', connected);
  $('#logoutBtn').classList.toggle('hidden', !connected);
}

/* =====================
   URL con "skip banner"
   ===================== */
function urlApi(path, params = {}){
  const u = new URL(CFG.ENDPOINT.replace(/\/$/, '') + '/api' + path);
  // Importante: usar query param (NO header) para evitar CORS preflight
  u.searchParams.set('ngrok-skip-browser-warning', 'true');
  for(const [k,v] of Object.entries(params)) u.searchParams.set(k, v);
  return u.toString();
}

/* =========
   TRACCAR
   ========= */
let pollTimer = null;
let map, marker;

async function login(){
  // POST /api/session con form-encoded (simple ‚Üí evita preflight)
  const body = new URLSearchParams({ email: CFG.EMAIL, password: CFG.PASSWORD });
  const res = await fetch(urlApi('/session'), {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body
  });
  if(!res.ok){
    const txt = await safeText(res);
    throw new Error(`Login fall√≥ (${res.status}). Respuesta: ${txt.slice(0,120)}‚Ä¶`);
  }
  const data = await res.json().catch(()=> ({}));
  log(`Login OK como: ${data.name ?? 'admin'}`, 'ok');
  setStatus(true);
}

async function logout(){
  try{
    await fetch(urlApi('/session'), { method:'DELETE', credentials:'include' });
  }catch{ /* no-op */ }
  clearPoll();
  setStatus(false);
  setAlert('Sesi√≥n cerrada (Basic Auth no mantiene estado).', true);
  log('Sesi√≥n cerrada.', 'muted');
}

function clearPoll(){
  if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
}

async function fetchLastPosition(){
  const res = await fetch(urlApi('/positions', { deviceId: CFG.DEVICE_ID }), {
    credentials:'include'
  });
  if(!res.ok){
    // Si vuelve HTML (401/403 o banner), lo capturamos y lo mostramos
    const txt = await safeText(res);
    throw new Error(`GET /positions ${res.status}. ${txt.slice(0,160)}‚Ä¶`);
  }
  const data = await res.json();
  if(!Array.isArray(data) || !data.length){
    throw new Error('Sin posiciones para el dispositivo.');
  }
  const p = data[0];
  renderPosition(p);
}

function renderPosition(p){
  const lat = p.latitude, lon = p.longitude;
  $('#latlon').textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
  $('#speed').textContent = (p.speed ?? 0).toFixed(2);
  $('#updated').textContent = new Date(p.deviceTime ?? p.serverTime ?? Date.now()).toLocaleString();

  if(!map){
    map = L.map('map').setView([lat, lon], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    marker = L.marker([lat, lon]).addTo(map);
  }else{
    marker.setLatLng([lat, lon]);
    // si el marcador se fue muy lejos, centra suave
    const dist = map.distance(map.getCenter(), [lat, lon]);
    if(dist > 1000) map.setView([lat, lon], map.getZoom());
  }
}

async function connectAndStart(){
  try{
    setAlert('');
    log('Iniciando login‚Ä¶');
    await login();
    setAlert('Conectado, obteniendo posici√≥n‚Ä¶', false);
    await fetchLastPosition();
    setAlert('');
    // Poll
    clearPoll();
    pollTimer = setInterval(async ()=>{
      try{
        await fetchLastPosition();
      }catch(e){
        log(`Poll: ${e.message}`, 'err');
      }
    }, CFG.POLL_MS);
  }catch(e){
    setStatus(false);
    setAlert('Error de autenticaci√≥n / CORS', true);
    log(`Fallo de sesi√≥n: ${e.message}`, 'err');
  }
}

/* ========
   HELPERS
   ======== */
async function safeText(res){
  try{return await res.text();}catch{return '';}
}

/* ==========
   EVENTOS UI
   ========== */
$('#connectBtn').addEventListener('click', connectAndStart);
$('#logoutBtn').addEventListener('click', logout);

$('#backBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  if (history.length > 1) history.back();
  else location.href = '/';
});

/* ==========================
   AUTO-CONECTAR AL INICIAR
   ========================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Conecta solo; si quieres modo "manual", comenta la l√≠nea siguiente:
  connectAndStart();
});
</script>
</body>
</html>


