<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Movilidad ‚Äî Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0d1117;--panel:#0f172a;--card:#111827;--muted:#6b7280;--text:#e5e7eb;
      --accent:#14a4ff;--accent2:#22c55e;--danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif;
    }
    header{
      position:sticky;top:0;z-index:10;background:#0b1220;border-bottom:1px solid #1f2937;
      display:grid;grid-template-columns:1fr auto 1fr;align-items:center;padding:12px 16px;gap:8px;
    }
    header .left, header .right{display:flex;gap:8px;align-items:center}
    header .center{justify-self:center;font-weight:700}
    .btn{
      background:#0b6fae;border:0;color:#fff;padding:8px 14px;border-radius:999px;cursor:pointer;
    }
    .btn.secondary{background:#213047}
    .btn.small{padding:6px 10px;font-size:13px}
    .chip{font-size:12px;background:#0b1220;border:1px solid #243041;color:#9fb2c9;padding:6px 10px;border-radius:999px}

    .wrap{
      padding:12px;display:grid;grid-template-columns: minmax(320px, 1.2fr) minmax(320px, 1fr);
      gap:12px;align-items:start;
    }

    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;overflow:hidden}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid #1f2937;background:#0f1626;font-size:14px;color:#9fb2c9}

    .toolbar{
      display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0f1626;border-bottom:1px solid #1f2937
    }
    .status{
      padding:8px 12px;font-size:14px;border-top:1px solid #1f2937;background:#0f1626
    }
    .status.error{color:#fff;background:#2a1012;border-top-color:#3d1418}
    .status.ok{color:#b8f7c4;background:#0f1f15;border-top-color:#153223}

    #map{width:100%;height:72vh}
    .cams{display:grid;grid-template-rows:1fr 1fr;gap:12px;padding:12px}
    .camBox{display:flex;align-items:center;justify-content:center;background:#0b1220;border:1px dashed #243041;border-radius:12px;height:34vh;color:#9fb2c9}

    .legend{padding:10px 12px;display:flex;gap:10px;flex-wrap:wrap}
    .log{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;color:#9fb2c9;background:#0b1220;border:1px solid #243041;border-radius:10px;padding:10px;white-space:pre-wrap}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    a{color:#8cd4ff;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <button id="btnVolver" class="btn small secondary">‚Üê Volver</button>
      <span class="chip">Fuente: Traccar (Basic)</span>
    </div>
    <div class="center">üöç Movilidad ‚Äî Panel</div>
    <div class="right">
      <button id="btnConectar" class="btn small">Conectar a Traccar</button>
      <button id="btnSalir" class="btn small secondary">Cerrar sesi√≥n</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Panel izquierdo -->
    <section class="card">
      <div class="toolbar row">
        <strong>üìç Posici√≥n ‚Äî <span id="deviceName">Ruta Tepic</span></strong>
        <span id="miniState" class="chip">Esperando‚Ä¶</span>
      </div>
      <div id="statusBanner" class="status">Listo</div>
      <div id="map"></div>
      <div class="legend row">
        <span>Lat/Lon: <strong id="latlon">‚Äî</strong></span>
        <span>Velocidad: <strong id="speed">‚Äî</strong></span>
        <span>Actualizado: <strong id="updated">‚Äî</strong></span>
      </div>
    </section>

    <!-- Panel derecho (C√°maras y logs) -->
    <section class="card">
      <h3>üì∫ C√°maras</h3>
      <div class="cams">
        <div class="camBox">Cam 1 (pendiente)</div>
        <div class="camBox">Cam 2 (pendiente)</div>
      </div>
      <h3>üß™ Logs</h3>
      <div id="logs" class="log">Sin eventos‚Ä¶</div>
    </section>
  </div>

  <script>
    // ============ CONFIG ============ //
    const CONFIG = {
      baseUrl   : "https://fbbf183c1610.ngrok-free.app",   // <--- tu ngrok
      deviceId  : 32324706,                                 // <--- tu deviceId
      user      : "valfrax.tec@gmail.com",                  // <--- tu usuario
      password  : "123456",                                  // <--- tu password
      center    : [21.508, -104.895],                        // Tepic aprox
      zoom      : 12
    };

    // Basic Auth
    const BASIC = "Basic " + btoa(`${CONFIG.user}:${CONFIG.password}`);

    // UI refs
    const $status    = document.getElementById("statusBanner");
    const $miniState = document.getElementById("miniState");
    const $latlon    = document.getElementById("latlon");
    const $speed     = document.getElementById("speed");
    const $updated   = document.getElementById("updated");
    const $logs      = document.getElementById("logs");
    const $btnCon    = document.getElementById("btnConectar");
    const $btnSalir  = document.getElementById("btnSalir");

    // Mapa
    const map = L.map("map").setView(CONFIG.center, CONFIG.zoom);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap" }).addTo(map);
    let marker = null;

    // Helpers UI
    function log(line){
      const now = new Date().toLocaleTimeString();
      $logs.textContent = `[${now}] ${line}\n` + $logs.textContent;
      console.log(line);
    }
    function setBanner(text, type=""){
      $status.textContent = text;
      $status.className   = "status" + (type ? ` ${type}` : "");
      $miniState.textContent = (type==="error" ? "Error" : "OK");
      $miniState.style.background = (type==="error" ? "#3a1720" : "#0b1220");
      $miniState.style.borderColor = (type==="error" ? "#5a1b26" : "#243041");
      $miniState.style.color = (type==="error" ? "#ffb8c2" : "#9fb2c9");
    }

    // Fetch gen√©rico con BASIC y sin cookies
    async function api(path, opts={}){
      const url = `${CONFIG.baseUrl}${path}`;
      const resp = await fetch(url, {
        method: opts.method || "GET",
        headers: {
          "Authorization": BASIC,
          ...(opts.headers || {})
        },
        body: opts.body || undefined,
        credentials: "omit" // üëà clave para no enviar cookies desde GitHub Pages/Neocities
      });

      // Si responde HTML es un 401/403 de ngrok/WAF
      const ct = resp.headers.get("content-type") || "";
      if (!ct.includes("application/json")){
        const txt = await resp.text();
        throw new Error(`La API devolvi√≥ HTML (posible 401/403/CORS). HTTP ${resp.status}.`);
      }

      if (!resp.ok){
        const t = await resp.text();
        throw new Error(`HTTP ${resp.status} ‚Äî ${t}`);
      }
      return resp.json();
    }

    // Probar sesi√≥n (con BASIC basta con cualquier endpoint; usamos /api/session GET)
    async function probarSesion(){
      try{
        const me = await api("/api/session");
        log("Login OK como: " + (me && me.name || "(desconocido)"));
        setBanner("Conectado a Traccar", "ok");
        return true;
      }catch(err){
        log("Fallo de sesi√≥n: " + err.message);
        setBanner("Error de autenticaci√≥n / CORS", "error");
        return false;
      }
    }

    async function obtenerPosicion(){
      try{
        const data = await api(`/api/positions?deviceId=${CONFIG.deviceId}`);
        if (!Array.isArray(data) || data.length===0){
          setBanner("Sin datos de posici√≥n", "error");
          return;
        }
        const p = data[0];
        const lat = p.latitude, lon = p.longitude;
        const spd = (p.speed || 0) * 1.94384; // knots aprox
        const when = p.fixTime ? new Date(p.fixTime).toLocaleString() : "‚Äî";

        if (!marker){
          marker = L.marker([lat, lon]).addTo(map);
        }else{
          marker.setLatLng([lat, lon]);
        }
        map.setView([lat, lon], 14);

        $latlon.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
        $speed.textContent  = `${spd.toFixed(1)} nudos`;
        $updated.textContent= when;

        setBanner("Posici√≥n obtenida", "ok");
      }catch(err){
        log("Error posiciones: " + err.message);
        setBanner("Error al obtener posici√≥n (ver consola/logs)", "error");
        throw err;
      }
    }

    async function ciclo(){
      const ok = await probarSesion();
      if (!ok) return;
      await obtenerPosicion();
    }

    // Botones
    $btnCon.addEventListener("click", ciclo);
    $btnSalir.addEventListener("click", ()=>{
      // No hay cookies que limpiar (Basic Auth). S√≥lo reseteamos UI.
      marker = null;
      setBanner("Sesi√≥n cerrada (visual). Vuelve a conectar.", "error");
      $latlon.textContent = "‚Äî";
      $speed.textContent  = "‚Äî";
      $updated.textContent= "‚Äî";
      log("Sesi√≥n 'cerrada' (Basic Auth no mantiene estado).");
    });

    // Inicio: no se llama autom√°tico para que puedas ver el banner
    setBanner("Listo. Pulsa ¬´Conectar a Traccar¬ª.");
  </script>
</body>
</html>
