<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movilidad ‚Äî Panel</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#0b0f15; --panel:#0f1522; --card:#111929; --muted:#0b1729;
      --text:#e6eef9; --accent:#14a4ff; --danger:#ef4444; --ok:#23ce5e;
      --border:1px solid #1b2a44;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#0c1423;color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif}
    header{position:sticky;top:0;z-index:20;display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;
      align-items:center;padding:12px 16px;border-bottom:var(--border);background:rgba(10,15,25,.7);backdrop-filter:blur(6px)}
    .title{font-weight:700}
    .pill{font-size:12px;color:#9fb3d2;background:#0b1729;border-radius:999px;padding:6px 10px;justify-self:start}
    .btn{background:transparent;color:var(--text);border:var(--border);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{border-color:#1e88ff;background:#0c213e}
    .btn.red{border-color:#ef4444;color:#ffb4b4}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .wrap{display:grid;grid-template-columns:1fr 520px;gap:16px;padding:16px}
    .card{background:var(--panel);border:var(--border);border-radius:14px}
    .card .hd{padding:10px 12px;border-bottom:var(--border);display:flex;align-items:center;gap:10px;background:#0f1522;border-top-left-radius:14px;border-top-right-radius:14px}
    .badge{color:#a4b6ce;font-size:12px}
    #errorBar{display:none;margin:0 16px 8px;padding:8px 12px;border-radius:10px;background:#2a0f14;color:#ffbdbd;border:1px solid #412027}
    #map{height:72vh;border-bottom-left-radius:14px;border-bottom-right-radius:14px}
    .cam{height:32vh;display:grid;place-items:center;color:#9fb3d2}
    .logs{height:22vh;font:12px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;overflow:auto;padding:10px;background:#0b1220;border-top:var(--border);border-bottom-left-radius:14px;border-bottom-right-radius:14px}
    .foot{display:flex;gap:18px;padding:8px 12px;border-top:var(--border)}
    .kv{font-size:12px;color:#b3c1d4}
    .kv b{color:#e6eef9}
    .muted{color:#8ea6c3}
    dialog{border:none;border-radius:14px;background:#0e1624;color:var(--text);width:min(520px,92vw);padding:0;overflow:hidden;box-shadow:0 20px 70px rgba(0,0,0,.5)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .mhd{padding:14px 16px;border-bottom:var(--border);background:#0f1522;font-weight:600}
    .mbd{padding:14px 16px;display:grid;gap:10px}
    .mft{padding:12px 16px;border-top:var(--border);display:flex;gap:8px;justify-content:flex-end}
    label{font-size:12px;color:#9db0c9}
    input{width:100%;background:#0c1321;color:var(--text);border:var(--border);padding:10px 12px;border-radius:10px;outline:none}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    a.link{color:#9ac6ff;text-decoration:none}
  </style>
</head>
<body>

  <header>
    <button id="btnBack" class="btn">‚Üê Volver</button>
    <div class="title">Movilidad ‚Äî <b>Panel</b></div>
    <span class="pill">Fuente: Traccar (B√°sic)</span>
    <div class="row">
      <button id="btnConnect" class="btn primary">Conectar a Traccar</button>
      <button id="btnLogout"  class="btn red" title="Limpia las credenciales guardadas">Cerrar sesi√≥n</button>
    </div>
  </header>

  <div id="errorBar" role="alert"></div>

  <section class="wrap">
    <article class="card">
      <div class="hd">
        <div>üìç <b>Posici√≥n ‚Äî Ruta Tepic</b></div>
        <span class="badge" id="statusBadge">Desconectado</span>
      </div>
      <div id="map"></div>
      <div class="foot">
        <div class="kv">Lat/Lon: <b id="kvLatLon" class="muted">‚Äî</b></div>
        <div class="kv">Velocidad: <b id="kvSpeed" class="muted">‚Äî</b></div>
        <div class="kv">Actualizado: <b id="kvWhen" class="muted">‚Äî</b></div>
      </div>
    </article>

    <aside>
      <article class="card">
        <div class="hd">üì∑ <b>C√°maras</b></div>
        <div class="cam">Cam 1 (pendiente)</div>
        <div class="cam" style="border-top:var(--border)">Cam 2 (pendiente)</div>
      </article>

      <article class="card" style="margin-top:16px">
        <div class="hd">üßæ <b>Logs</b></div>
        <pre class="logs" id="logs"></pre>
      </article>
    </aside>
  </section>

  <!-- MODAL -->
  <dialog id="dlg">
    <div class="mhd">Conectar a Traccar</div>
    <div class="mbd">
      <div>
        <label>Endpoint (ngrok/host) *</label>
        <input id="fBase" placeholder="https://xxxxx.ngrok-free.app" />
        <small class="muted">Debe servir <code>/api/*</code> y estar permitido en <code>web.origin</code> de Traccar.</small>
      </div>
      <div class="two">
        <div>
          <label>Usuario (email) *</label>
          <input id="fUser" placeholder="admin@ejemplo.com" />
        </div>
        <div>
          <label>Contrase√±a *</label>
          <input id="fPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>
      <div>
        <label>Device ID *</label>
        <input id="fDev" placeholder="32324706" />
      </div>
      <small class="muted">Consejo: reinicia Traccar despu√©s de editar <code>traccar.xml</code>.</small>
    </div>
    <div class="mft">
      <button class="btn" id="btnCancel">Cancelar</button>
      <button class="btn primary" id="btnSave">Guardar</button>
    </div>
  </dialog>

<script>
/* ========= Estado/UI ========= */
const UI = {
  back:document.getElementById('btnBack'),
  err:document.getElementById('errorBar'),
  logs:document.getElementById('logs'),
  badge:document.getElementById('statusBadge'),
  latlon:document.getElementById('kvLatLon'),
  speed:document.getElementById('kvSpeed'),
  when:document.getElementById('kvWhen'),
  btnConn:document.getElementById('btnConnect'),
  btnOut:document.getElementById('btnLogout'),
  dlg:document.getElementById('dlg'),
  fBase:document.getElementById('fBase'),
  fUser:document.getElementById('fUser'),
  fPass:document.getElementById('fPass'),
  fDev:document.getElementById('fDev'),
  btnCancel:document.getElementById('btnCancel'),
  btnSave:document.getElementById('btnSave')
};

const S = {
  base: localStorage.getItem('trk.base') || '',
  user: localStorage.getItem('trk.user') || '',
  pass: localStorage.getItem('trk.pass') || '',
  dev : localStorage.getItem('trk.dev')  || '',
  basic:'', map:null, marker:null
};

function log(t=''){ UI.logs.textContent += t+'\n'; UI.logs.scrollTop = UI.logs.scrollHeight; }
function showErr(t){ UI.err.style.display='block'; UI.err.textContent=t; log(t); }
function clearErr(){ UI.err.style.display='none'; }
function setBadge(t){ UI.badge.textContent=t; }

/* ========= Botones b√°sicos ========= */
UI.back.onclick = ()=> (history.length>1 ? history.back() : location.href='/');
UI.btnConn.onclick = ()=>{
  UI.fBase.value = S.base; UI.fUser.value = S.user; UI.fPass.value = S.pass; UI.fDev.value = S.dev;
  UI.dlg.showModal();
};
UI.btnCancel.onclick = ()=>UI.dlg.close();
UI.btnSave.onclick = ()=>{
  S.base = (UI.fBase.value||'').trim().replace(/\/+$/,'');
  S.user = (UI.fUser.value||'').trim();
  S.pass = UI.fPass.value||'';
  S.dev  = (UI.fDev.value||'').trim();
  if(!S.base||!S.user||!S.pass||!S.dev){ showErr('Completa todos los campos.'); return; }
  localStorage.setItem('trk.base', S.base);
  localStorage.setItem('trk.user', S.user);
  localStorage.setItem('trk.pass', S.pass);
  localStorage.setItem('trk.dev',  S.dev);
  S.basic = 'Basic '+btoa(`${S.user}:${S.pass}`);
  UI.dlg.close();
  clearErr(); log('Credenciales guardadas. Probando‚Ä¶');
  refreshOnce();
};

UI.btnOut.onclick = ()=>{
  localStorage.removeItem('trk.base');
  localStorage.removeItem('trk.user');
  localStorage.removeItem('trk.pass');
  localStorage.removeItem('trk.dev');
  S.base=S.user=S.pass=S.dev=''; S.basic='';
  setBadge('Desconectado');
  UI.latlon.textContent = UI.speed.textContent = UI.when.textContent = '‚Äî';
  if(S.marker && S.map){ S.map.removeLayer(S.marker); S.marker=null; }
  showErr('Sesi√≥n local eliminada. Pulsa ‚ÄúConectar a Traccar‚Äù.');
};

/* ========= Helper API con FIX ngrok ========= */
function withNgrokSkip(url){
  // a√±ade ?ngrok-skip-browser-warning=1 a cualquier URL
  return url + (url.includes('?') ? '&' : '?') + 'ngrok-skip-browser-warning=1';
}
async function api(path, opts={}){
  if(!S.base) throw new Error('Configura el endpoint.');
  const url = withNgrokSkip(S.base + path);
  const resp = await fetch(url,{
    method: opts.method||'GET',
    headers:{
      'Authorization': S.basic,
      'Accept':'application/json',
      'ngrok-skip-browser-warning':'true',
      ...(opts.headers||{})
    },
    body: opts.body,
    credentials:'omit',
    mode:'cors',
    cache:'no-store'
  });

  const ct = resp.headers.get('content-type')||'';
  if(!ct.includes('application/json')){
    const text = await resp.text();
    throw new Error(`La API devolvi√≥ HTML (posible aviso ngrok/CORS). HTTP ${resp.status}. URL: ${url}`);
  }
  if(!resp.ok){
    const t = await resp.text();
    throw new Error(`HTTP ${resp.status} ‚Äî ${t}`);
  }
  return resp.json();
}

/* ========= L√≥gica ========= */
async function refreshOnce(){
  try{
    if(!S.basic && S.user && S.pass) S.basic = 'Basic '+btoa(`${S.user}:${S.pass}`);
    if(!S.dev) throw new Error('DeviceId no configurado.');

    setBadge('Conectando‚Ä¶');

    const me = await api('/api/session');
    log(`Login OK como: ${me.name ?? me.email ?? 'admin'}`);

    const to   = new Date();
    const from = new Date(to.getTime() - 24*60*60*1000);
    const qs = `?deviceId=${encodeURIComponent(S.dev)}&from=${from.toISOString()}&to=${to.toISOString()}`;
    const pos = await api('/api/positions'+qs);

    if(!Array.isArray(pos) || pos.length===0){
      setBadge('Sin datos'); showErr('No hay posiciones en las √∫ltimas 24h.');
      return;
    }
    const last = pos[pos.length-1];
    pintar(last);
    setBadge('Conectado');
    clearErr();
  }catch(e){
    setBadge('Error');
    showErr(e.message);
  }
}

function pintar(p){
  const lat=p.latitude, lon=p.longitude, spd=p.speed??0;
  const when = p.fixTime || p.deviceTime || p.serverTime;
  UI.latlon.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
  UI.speed.textContent  = `${spd.toFixed(2)} nudos`;
  UI.when.textContent   = when ? new Date(when).toLocaleString() : '‚Äî';

  if(!S.map){
    S.map = L.map('map').setView([lat,lon], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(S.map);
    S.marker = L.marker([lat,lon]).addTo(S.map);
  }else{
    S.marker.setLatLng([lat,lon]);
    S.map.setView([lat,lon]);
  }
}

/* ========= Init ========= */
(function(){
  if(S.base&&S.user&&S.pass&&S.dev){
    S.basic='Basic '+btoa(`${S.user}:${S.pass}`);
    refreshOnce();
  }else{
    setBadge('Desconectado');
    showErr('Pulsa ‚ÄúConectar a Traccar‚Äù y completa los campos.');
  }
})();
</script>
</body>
</html>

