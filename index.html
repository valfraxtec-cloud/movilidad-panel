<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movilidad ‚Äî Panel</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#0b0f15; --panel:#0f1522; --card:#11192b; --muted:#9fb0c7; --text:#e6eef9;
      --accent:#41a4ff; --accent2:#22c55e; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%, #12203a 0%, #0b0f15 45%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif}

    header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #1b2a44;background:rgba(10,15,25,.7);backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:10px;background:conic-gradient(from 70deg,#41a4ff,#22c55e,#41a4ff);display:grid;place-items:center;box-shadow:0 0 0 1px #1b2a44}
    h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.3px}
    .top-actions{display:flex;gap:8px}
    .btn{border-radius:12px;border:1px solid #20334f;background:#0c1322;color:var(--text);padding:8px 12px;font-size:13px;cursor:pointer}
    .btn.ghost{background:transparent;border-color:#2a3a57}

    .container{padding:14px}
    .badge{font-size:12px;border:1px solid #274166;background:#0d1628;color:#b7c5da;border-radius:999px;padding:6px 10px}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}

    .panel{background:linear-gradient(180deg,#0f1726,#0a0f1b);border:1px solid #1b2a44;border-radius:16px;overflow:hidden}
    .panel h3{margin:0;padding:12px 14px;border-bottom:1px solid #1b2a44;font-size:16px;display:flex;align-items:center;gap:8px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    #map{height: calc(78vh - 56px)}
    .cams{display:flex;flex-direction:column;gap:16px;height:calc(78vh - 56px);padding:16px}
    .camBox{flex:1;background:#000;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#9aa7bd;border:1px solid #1b2a44}

    .statusbar{display:flex;gap:16px;align-items:center;padding:8px 14px;color:#b9c7de;border-top:1px solid #1b2a44;font-size:12px}
    .errorText{color:var(--danger);font-weight:600}
    .muted{color:#9fb0c7}

    .logs{background:#0c1322;border:1px solid #1b2a44;border-radius:12px;margin-top:12px;color:#b9c7de;font-size:12px}
    .logs h4{margin:0;padding:10px 12px;border-bottom:1px solid #1b2a44}
    .logs pre{margin:0;padding:10px 12px;max-height:160px;overflow:auto;white-space:pre-wrap}

    @media (max-width: 980px){
      .split{grid-template-columns:1fr}
      #map,.cams{height:60vh}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand"><div class="logo">üöç</div><h1>Movilidad ‚Äî Panel</h1></div>
    <div class="top-actions">
      <button class="btn ghost" id="btnBack">‚Üê Volver</button>
      <button class="btn ghost" id="btnLogout">Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <div class="toolbar">
      <span class="badge">üõ∞ Fuente: Traccar Demo (v√≠a GitHub)</span>
      <div class="muted" id="srcInfo">Leyendo ./data/positions.json</div>
    </div>

    <div class="split">
      <!-- Izquierda: MAPA -->
      <section class="panel">
        <h3>üìç Posici√≥n ‚Äî <span id="routeName">Ruta Tepic</span>
          <small id="errText" class="errorText" style="margin-left:10px;"></small>
        </h3>
        <div id="map"></div>
        <div class="statusbar">
          <div>Lat/Lon: <span id="latlon" class="muted">‚Äî</span></div>
          <div>Velocidad: <span id="speed" class="muted">‚Äî nudos</span></div>
          <div>Actualizado: <span id="updated" class="muted">‚Äî</span></div>
          <div class="muted">| refresco cada <span id="everySec">15</span>s</div>
          <button class="btn ghost" id="btnRefresh" style="margin-left:auto">Refrescar ahora</button>
        </div>
      </section>

      <!-- Derecha: C√ÅMARAS -->
      <section class="panel">
        <h3>üé• C√°maras</h3>
        <div class="cams">
          <div class="camBox">Cam 1 (pendiente)</div>
          <div class="camBox">Cam 2 (pendiente)</div>
        </div>

        <div class="logs">
          <h4>üìù Logs</h4>
          <pre id="logBox">Sin eventos‚Ä¶</pre>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ========= CONFIG =========
    // Archivo generado por el workflow (debe existir en el repo)
    const POSITIONS_JSON_URL = './data/positions.json';
    // Intervalo de refresco del panel (independiente del cron del workflow)
    const POLL_SECONDS = 15;

    // ========= ESTADO/UI =========
    const errText   = document.getElementById('errText');
    const latlonEl  = document.getElementById('latlon');
    const speedEl   = document.getElementById('speed');
    const updatedEl = document.getElementById('updated');
    const logBox    = document.getElementById('logBox');
    const everySec  = document.getElementById('everySec');
    everySec.textContent = POLL_SECONDS;

    // Botones: mantener comportamiento de tu interfaz
    document.getElementById('btnBack').addEventListener('click', () => {
      // Preferente: volver a la p√°gina anterior (panel de rutas)
      if (history.length > 1) history.back();
      else window.location.href = './'; // fallback
    });
    document.getElementById('btnLogout').addEventListener('click', () => {
      // Si tienes pantalla de login separada, redir√≠gela aqu√≠
      // o limpia estado local y recarga
      try { sessionStorage.clear(); localStorage.removeItem('TRACCAR_SESSION'); } catch{}
      window.location.href = './';
    });

    document.getElementById('btnRefresh').addEventListener('click', () => {
      refreshOnce(true);
    });

    // ========= MAPA =========
    let map, marker, pollId;
    function initMap(){
      if(map) return;
      map = L.map('map', { zoomControl:true, attributionControl:true })
              .setView([23.6345,-102.5528], 5); // vista M√©xico
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
    }

    // ========= UTIL =========
    function log(msg){
      const ts = new Date().toLocaleTimeString();
      logBox.textContent = `[${ts}] ${msg}\n` + (logBox.textContent || '');
    }

    function fmtTime(iso){
      if(!iso) return '‚Äî';
      try{
        const d = new Date(iso);
        return d.toLocaleString();
      }catch{ return iso; }
    }

    // Lee data/positions.json (array Traccar) desde GitHub Pages
    async function loadPositionsJson(){
      const url = `${POSITIONS_JSON_URL}?_=${Date.now()}`; // cache-busting
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status} al leer positions.json`);
      const data = await res.json();
      if(!Array.isArray(data)) throw new Error('positions.json no es un array v√°lido');
      return data;
    }

    async function refreshOnce(manual=false){
      try{
        initMap();
        errText.textContent = '';
        if (manual) log('Refresco manual solicitado.');

        const arr = await loadPositionsJson();
        const pos = arr?.[0] || null;
        if(!pos){
          errText.textContent = 'Sin datos en positions.json a√∫n.';
          log('Sin posiciones (array vac√≠o). ¬øWorkflow ya corri√≥?');
          return;
        }

        const lat = Number(pos.latitude);
        const lon = Number(pos.longitude);
        const spd = (typeof pos.speed === 'number') ? pos.speed : (pos.attributes?.speed ?? null);
        const when = pos.deviceTime || pos.serverTime || pos.fixTime;

        if(Number.isFinite(lat) && Number.isFinite(lon)){
          if(!marker){
            marker = L.marker([lat, lon]).addTo(map);
            map.setView([lat, lon], 16);
          }else{
            marker.setLatLng([lat, lon]);
          }
          latlonEl.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
        }else{
          latlonEl.textContent = '‚Äî';
        }

        if (Number.isFinite(spd)) speedEl.textContent = `${spd} nudos`;
        updatedEl.textContent = fmtTime(when);

        log(`Posici√≥n OK: ${lat?.toFixed?.(5)}, ${lon?.toFixed?.(5)} ‚Äî ${fmtTime(when)}`);
      }catch(e){
        console.error(e);
        errText.textContent = 'Error: no se pudo obtener la posici√≥n (JSON).';
        log(`Error al leer positions.json: ${e.message}`);
      }
    }

    function start(){
      refreshOnce();
      if(pollId) clearInterval(pollId);
      pollId = setInterval(refreshOnce, POLL_SECONDS * 1000);
    }

    // GO!
    start();
  </script>
</body>
</html>




