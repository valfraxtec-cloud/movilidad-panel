<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movilidad — Panel (Prueba aislada)</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#0b0f15;--panel:#0f1522;--card:#111929;--muted:#789;--text:#e6eef9;--accent:#14a4ff
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 10% 10%,#12203a 0%, #0b0f15 45%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:12px 16px;background:rgba(10,15,25,.7);backdrop-filter:blur(6px);position:sticky;top:0;z-index:10;border-bottom:1px solid #1b2a44;box-shadow:0 0 1px #1b2a44}
    header .left{display:flex;gap:8px;align-items:center}
    header .btn{border:1px solid #22364e;background:#0f1522;padding:10px 14px;border-radius:10px;color:var(--text);cursor:pointer}
    header .btn:hover{background:#122034}
    main{padding:14px}
    .grid{display:grid;grid-template-columns: minmax(280px,1fr) minmax(420px,1.4fr);gap:14px}
    #map{height:70vh;border-radius:12px;overflow:hidden;box-shadow:0 0 0 1px #1b2a44}
    .card{background:#0f1522;border-radius:12px;padding:14px;box-shadow:0 0 0 1px #1b2a44}
    .muted{color:#9bb0c6;font-size:.92rem}
    .ok{color:#5ef0a0}
    .bad{color:#ff6f6f}
    code.small{font-size:.82rem}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <strong>Movilidad — Panel (Prueba)</strong>
      <span id="status" class="muted">Desconectado</span>
    </div>
    <div class="right">
      <button id="btnConnect" class="btn">Conectar a Traccar</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <div class="card">
        <div style="margin-bottom:8px">
          <div class="muted">Posición — <span id="deviceName">Rutas-Tepic</span></div>
          <div id="msg" class="muted"></div>
        </div>
        <div id="map"></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Detalles</h3>
        <div class="muted">Lat: <span id="lat">—</span> &nbsp; Lon: <span id="lon">—</span></div>
        <div class="muted">Velocidad: <span id="speed">—</span> nudos</div>
        <div class="muted">Actualizado: <span id="updated">—</span></div>
        <hr style="border-color:#1b2a44">
        <div class="muted">Logs</div>
        <pre id="logs" style="max-height:45vh;overflow:auto;background:#0b0f15;border-radius:8px;padding:10px;border:1px solid #1b2a44"></pre>
        <div class="muted" style="margin-top:6px">Si aparece <code class="small">&lt;html&gt;…</code> o <code class="small">&lt;!DOCTYPE…</code> en los logs, la API devolvió HTML (ngrok/401/403) y no JSON.</div>
      </div>
    </div>
  </main>

  <script>
    // ===========================
    // Configuración
    // ===========================
    const TRACCAR_BASE = 'https://fbbf183c1610.ngrok-free.app';   // <- tu ngrok actual
    const TRACCAR_EMAIL = 'valfrax.tec@gmail.com';
    const TRACCAR_PASS  = '123456';
    const DEVICE_ID     = '32324706';                              // Rutas-Tepic

    // ===========================
    // Utilidades simples de UI
    // ===========================
    const $ = (sel)=>document.querySelector(sel);
    const logs = $('#logs');
    function log(...a){ logs.textContent += a.join(' ') + '\n'; logs.scrollTop = logs.scrollHeight; }
    function setStatus(txt, ok=false){
      const el = $('#status');
      el.textContent = txt;
      el.className = ok ? 'ok' : 'bad';
    }
    function setMsg(txt, bad=false){
      const el = $('#msg');
      el.textContent = txt;
      el.className = bad ? 'bad' : 'muted';
    }

    // ===========================
    // Leaflet
    // ===========================
    const map = L.map('map').setView([21.5,-104.9], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    let marker = null;

    function updateMarker(lat, lon){
      if (!marker){
        marker = L.marker([lat, lon]).addTo(map);
      } else {
        marker.setLatLng([lat, lon]);
      }
      map.setView([lat,lon], map.getZoom() < 12 ? 12 : map.getZoom());
      $('#lat').textContent = lat.toFixed(6);
      $('#lon').textContent = lon.toFixed(6);
    }

    // ===========================
    // Llamadas seguras a Traccar
    // ===========================
    async function traccarLogin(){
      log('→ POST /api/session');
      const r = await fetch(`${TRACCAR_BASE}/api/session`, {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ email: TRACCAR_EMAIL, password: TRACCAR_PASS }),
        credentials: 'include' // guarda cookie
      });

      const ct = r.headers.get('content-type') || '';
      const raw = await r.text();

      if (!r.ok){
        log('Login ERROR', r.status, raw.slice(0,200));
        throw new Error(`Login falló (${r.status})`);
      }
      if (!ct.includes('application/json')){
        log('Login devolvió no-JSON. CT=', ct, 'Body:', raw.slice(0,200));
        throw new Error('Login no devolvió JSON (ver logs)');
      }
      const json = JSON.parse(raw);
      log('Login OK como:', json.name || json.email || 'desconocido');
      return json;
    }

    async function traccarGetPositions(deviceId){
      const url = new URL(`${TRACCAR_BASE}/api/positions`);
      url.searchParams.set('deviceId', deviceId);
      log('→ GET', url.toString());
      const r = await fetch(url, { credentials: 'include' });

      const ct = r.headers.get('content-type') || '';
      const raw = await r.text();

      if (!r.ok){
        log('Positions ERROR', r.status, raw.slice(0,200));
        throw new Error(`Positions falló (${r.status})`);
      }
      if (!ct.includes('application/json')){
        log('Positions devolvió no-JSON. CT=', ct, 'Body:', raw.slice(0,200));
        throw new Error('Positions no devolvió JSON (ver logs)');
      }
      const json = JSON.parse(raw);
      return json;
    }

    // ===========================
    // Flujo
    // ===========================
    let pollHandle = null;

    async function conectar(){
      try{
        setStatus('Conectando…');
        setMsg('Haciendo login en Traccar…');
        await traccarLogin();
        setStatus('Conectado', true);
        setMsg('Obteniendo posiciones…');

        await obtenerYMostrar(); // primer tiro
        if (pollHandle) clearInterval(pollHandle);
        pollHandle = setInterval(obtenerYMostrar, 15000); // cada 15 s
      }catch(err){
        console.error(err);
        setStatus('Error', false);
        setMsg(err.message || String(err), true);
      }
    }

    async function obtenerYMostrar(){
      try{
        const data = await traccarGetPositions(DEVICE_ID);
        if (!Array.isArray(data) || data.length === 0){
          setMsg('No hay posiciones para el dispositivo.', true);
          return;
        }
        const p = data[0];
        $('#deviceName').textContent = 'Rutas-Tepic';
        $('#speed').textContent = (p.speed ?? 0).toFixed(2);
        $('#updated').textContent = p.deviceTime || p.serverTime || p.fixTime || '—';

        if (typeof p.latitude === 'number' && typeof p.longitude === 'number'){
          updateMarker(p.latitude, p.longitude);
          setMsg('Posición actualizada.');
        }else{
          setMsg('La respuesta no tiene lat/lon válidos.', true);
          log('Objeto posición:', JSON.stringify(p).slice(0,300));
        }
      }catch(err){
        console.error(err);
        setMsg(err.message || String(err), true);
        setStatus('Conectado (con errores)', false);
      }
    }

    // ===========================
    // Eventos
    // ===========================
    $('#btnConnect').addEventListener('click', conectar);
  </script>
</body>
</html>
